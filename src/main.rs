//! RedisæœåŠ¡å™¨ä¸»ç¨‹åº - å±•ç¤ºRustçš„å¼‚æ­¥å¹¶å‘
//!
//! Rustç‰¹ç‚¹å±•ç¤º:
//! - tokioå¼‚æ­¥è¿è¡Œæ—¶
//! - å¹¶å‘ä»»åŠ¡å¤„ç†
//! - é”™è¯¯å¤„ç†å’Œä¼ æ’­

use redis_lib::connection::{cleanup_task, Connection};
use redis_lib::store::Store;
use redis_lib::{DEFAULT_PORT, VERSION};
use std::env;
use tokio::net::TcpListener;

/// ç¨‹åºå…¥å£ç‚¹
///
/// Rustç‰¹ç‚¹:
/// - #[tokio::main] å®è®¾ç½®å¼‚æ­¥è¿è¡Œæ—¶
/// - Resultè¿”å›ç±»å‹å…è®¸ä½¿ç”¨?æ“ä½œç¬¦
#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // æ‰“å°æ¬¢è¿ä¿¡æ¯
    print_banner();

    // è§£æå‘½ä»¤è¡Œå‚æ•°è·å–ç«¯å£
    let port = parse_port();

    // åˆ›å»ºå…±äº«å­˜å‚¨
    // Rustç‰¹ç‚¹: Storeå®ç°äº†Cloneï¼Œå†…éƒ¨ä½¿ç”¨Arcå®ç°å…±äº«
    let store = Store::new();

    // å¯åŠ¨åå°æ¸…ç†ä»»åŠ¡
    // Rustç‰¹ç‚¹: tokio::spawnåˆ›å»ºç‹¬ç«‹çš„å¼‚æ­¥ä»»åŠ¡
    let cleanup_store = store.clone();
    tokio::spawn(async move {
        cleanup_task(cleanup_store, 10).await;
    });

    // ç»‘å®šTCPç›‘å¬å™¨
    let addr = format!("0.0.0.0:{}", port);
    let listener = TcpListener::bind(&addr).await?;

    println!("ğŸš€ æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ {}", addr);
    println!("ğŸ“ æ”¯æŒçš„å‘½ä»¤: PING, GET, SET, DEL, EXISTS, KEYS, INCR, DECR, TTL, EXPIRE ç­‰");
    println!("ğŸ’¡ ä½¿ç”¨ redis-cli æˆ– telnet è¿æ¥æµ‹è¯•");
    println!();

    // æ¥å—è¿æ¥å¾ªç¯
    // Rustç‰¹ç‚¹: loopæ˜¯æ— é™å¾ªç¯ï¼Œæ¯”while trueæ›´æƒ¯ç”¨
    loop {
        // ç­‰å¾…æ–°è¿æ¥
        // Rustç‰¹ç‚¹: æ¨¡å¼åŒ¹é…è§£æ„å…ƒç»„
        let (socket, _addr) = listener.accept().await?;

        // ä¸ºæ¯ä¸ªè¿æ¥å…‹éš†store
        let conn_store = store.clone();

        // ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºæ–°ä»»åŠ¡
        // Rustç‰¹ç‚¹:
        // - move é—­åŒ…è·å–å˜é‡æ‰€æœ‰æƒ
        // - async move åˆ›å»ºå¼‚æ­¥é—­åŒ…
        tokio::spawn(async move {
            let mut connection = Connection::new(socket);

            // å¤„ç†è¿æ¥ï¼Œå¿½ç•¥é”™è¯¯ï¼ˆå·²åœ¨handleä¸­è®°å½•æ—¥å¿—ï¼‰
            if let Err(e) = connection.handle(&conn_store).await {
                eprintln!("[{}] è¿æ¥é”™è¯¯: {}", connection.addr(), e);
            }
        });
    }
}

/// æ‰“å°æ¬¢è¿æ¨ªå¹…
fn print_banner() {
    println!(
        r#"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                           â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                      â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•                      â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘                         â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘                         â•‘
â•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘                         â•‘
â•‘   â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•   â•šâ•â•                         â•‘
â•‘                                                           â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                     â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•                     â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                     â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘                     â•‘
â•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘                     â•‘
â•‘   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â• â•šâ•â•â•šâ•â•â•â•â•â•â•                     â•‘
â•‘                                                           â•‘
â•‘   ç‰ˆæœ¬: v{}                                             â•‘
â•‘   ä¸€ä¸ªç”¨Rustå®ç°çš„ç®€å•RedisæœåŠ¡å™¨                         â•‘
â•‘                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"#,
        VERSION
    );
}

/// ä»å‘½ä»¤è¡Œå‚æ•°è§£æç«¯å£å·xxx
fn parse_port() -> u16 {
    // Rustç‰¹ç‚¹: è¿­ä»£å™¨å’ŒOptionçš„é“¾å¼è°ƒç”¨
    env::args()
        .nth(1)
        .and_then(|arg| arg.parse().ok())
        .unwrap_or(DEFAULT_PORT)
}

